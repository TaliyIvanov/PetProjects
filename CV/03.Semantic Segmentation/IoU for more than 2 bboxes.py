import torch
"""
–ó–¥–µ—Å—å —É–∂–µ –±—É–¥–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –±–û–ª—å—à–µ–≥–æ –∫–æ–ª-–≤–∞
–±–æ–∫—Å–æ–≤.

–î–æ–ø—É—Å—Ç–∏–º —É –Ω–∞—Å –µ—Å—Ç—å 3 –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã—Ö –∏ 3 —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞–º–∫–∏
"""

def boxes_IoU(boxes1, boxes2):
    """
    
    Parameters:
        boxes1: torch.Tensor, size(N,4)
        boxes2: torch.Tensor, size(M,4)
    Returns:
        iou: torch.Tensor, size(N,M)
    """
    # –≤–µ–∫—Ç–æ—Ä –ø–ª–æ—â–∞–¥–µ–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã—Ö –±–æ–∫—Å–æ–≤
    area1 = (boxes1[:, 2] - boxes1[:, 0]) * (boxes1[:, 3] - boxes1[:, 1]) 
    # –≤–µ–∫—Ç–æ—Ä –ø–ª–æ—â–∞–¥–µ–π —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –±–æ–∫—Å–æ–≤
    area2 = (boxes2[:, 2] - boxes2[:, 0]) * (boxes2[:, 3] - boxes2[:, 1]) 

    lt = torch.max(boxes1[:, None, :2], boxes2[:, :2]) # size (N, M, 2)
    rb = torch.max(boxes1[:, None, 2:], boxes2[:, 2:]) # size (N, M, 2)

    wh = (rb - lt).clamp(min=0) # size (N, M, 2)

    inter = wh[..., 0] * wh[..., 1]
    union = area1[:, None] + area2 - inter

    IoU = inter / union

    return IoU



"""
## üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

–§—É–Ω–∫—Ü–∏—è `boxes_IoU(boxes1, boxes2)` –≤—ã—á–∏—Å–ª—è–µ—Ç **–º–∞—Ç—Ä–∏—Ü—É IoU** (intersection over union) –º–µ–∂–¥—É –¥–≤—É–º—è –Ω–∞–±–æ—Ä–∞–º–∏ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã—Ö –±–æ–∫—Å–æ–≤.
IoU ‚Äî —ç—Ç–æ –º–µ—Ç—Ä–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –∏–∑–º–µ—Ä—è–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –¥–≤—É—Ö –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏—Ö –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:

$$
\text{IoU} = \frac{\text{–ü–ª–æ—â–∞–¥—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è}}{\text{–ü–ª–æ—â–∞–¥—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è}}
$$

---

## üî¢ –ü—Ä–∏–º–µ—Ä –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–í–æ–∑—å–º–µ–º –ø—Ä–æ—Å—Ç—ã–µ –±–æ–∫—Å—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ `(x1, y1, x2, y2)`:

```python
import torch

boxes1 = torch.tensor([
    [0, 0, 2, 2],   # –±–æ–∫—Å 1
    [1, 1, 3, 3],   # –±–æ–∫—Å 2
    [0, 0, 1, 1]    # –±–æ–∫—Å 3
])

boxes2 = torch.tensor([
    [1, 1, 2, 2],   # –±–æ–∫—Å A
    [0, 0, 1, 1],   # –±–æ–∫—Å B
    [2, 2, 4, 4]    # –±–æ–∫—Å C
])
```

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å 3 –±–æ–∫—Å–∞ –≤ –∫–∞–∂–¥–æ–º —Å–ø–∏—Å–∫–µ. –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –º–∞—Ç—Ä–∏—Ü–µ–π `IoU` —Ä–∞–∑–º–µ—Ä–∞ `3x3`, 
–≥–¥–µ `IoU[i][j]` ‚Äî —ç—Ç–æ IoU –º–µ–∂–¥—É `boxes1[i]` –∏ `boxes2[j]`.

---

## üß† –ü–æ—à–∞–≥–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

area1 = (boxes1[:, 2] - boxes1[:, 0]) * (boxes1[:, 3] - boxes1[:, 1])

‚Üí –í—ã—á–∏—Å–ª—è–µ—Ç –ø–ª–æ—â–∞–¥–∏ –±–æ–∫—Å–æ–≤ –∏–∑ `boxes1`:

* –ë–æ–∫—Å 1: (2-0)\*(2-0) = 4
* –ë–æ–∫—Å 2: (3-1)\*(3-1) = 4
* –ë–æ–∫—Å 3: (1-0)\*(1-0) = 1

area2 = (boxes2[:, 2] - boxes2[:, 0]) * (boxes2[:, 3] - boxes2[:, 1])

‚Üí –¢–æ –∂–µ –¥–ª—è `boxes2`:

* –ë–æ–∫—Å A: (2-1)\*(2-1) = 1
* –ë–æ–∫—Å B: (1-0)\*(1-0) = 1
* –ë–æ–∫—Å C: (4-2)\*(4-2) = 4

lt = torch.max(boxes1[:, None, :2], boxes2[:, :2])  # (N, M, 2)


‚Üí –ù–∞—Ö–æ–¥–∏—Ç **–ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è** –∫–∞–∂–¥–æ–≥–æ –±–æ–∫—Å–∞ –∏–∑ `boxes1` –∏ `boxes2`.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `broadcasting`, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –º–∞—Ç—Ä–∏—Ü—É `3x3`.

–ù–∞–ø—Ä–∏–º–µ—Ä:

* `boxes1[0] vs boxes2[0]`: max(\[0,0], \[1,1]) = \[1,1]
* `boxes1[0] vs boxes2[1]`: max(\[0,0], \[0,0]) = \[0,0]
* `boxes1[0] vs boxes2[2]`: max(\[0,0], \[2,2]) = \[2,2]

rb = torch.min(boxes1[:, None, 2:], boxes2[:, 2:])  # (N, M, 2)


‚Üí –ù–∞—Ö–æ–¥–∏—Ç **–ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è**:

* `boxes1[0] vs boxes2[0]`: min(\[2,2], \[2,2]) = \[2,2]
* `boxes1[0] vs boxes2[1]`: min(\[2,2], \[1,1]) = \[1,1]
* `boxes1[0] vs boxes2[2]`: min(\[2,2], \[4,4]) = \[2,2]

wh = (rb - lt).clamp(min=0)

‚Üí –í—ã—á–∏—Å–ª—è–µ—Ç —à–∏—Ä–∏–Ω—É –∏ –≤—ã—Å–æ—Ç—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è. –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è ‚Äî clamp –æ–±–Ω—É–ª—è–µ—Ç:

* –ü—Ä–∏–º–µ—Ä: lt=\[2,2], rb=\[2,2] ‚Üí wh=\[0,0]
* –ü—Ä–∏–º–µ—Ä: lt=\[1,1], rb=\[2,2] ‚Üí wh=\[1,1]


inter = wh[..., 0] * wh[..., 1]


‚Üí –ü–ª–æ—â–∞–¥—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è: —à–∏—Ä–∏–Ω–∞ √ó –≤—ã—Å–æ—Ç–∞

union = area1[:, None] + area2 - inter

‚Üí –ü–ª–æ—â–∞–¥—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è: —Å—É–º–º–∞ –ø–ª–æ—â–∞–¥–µ–π –º–∏–Ω—É—Å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ

IoU = inter / union

‚Üí –î–µ–ª–∏–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ ‚Äî –ø–æ–ª—É—á–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é –º–∞—Ç—Ä–∏—Ü—É IoU —Ä–∞–∑–º–µ—Ä–∞ `(3x3)`

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ

–ï—Å–ª–∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è, —Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è:

|                | A (1,1,2,2)                        | B (0,0,1,1)                           | C (2,2,4,4)                          |
| -------------- | ---------------------------------- | ------------------------------------- | ------------------------------------ |
| Box1 (0,0,2,2) | IoU = 1 / (4+1-1) = 1/4 = **0.25** | 1 / (4+1-1) = 1/4 = **0.25**          | –Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è ‚Üí 0                  |
| Box2 (1,1,3,3) | IoU = 1 / (4+1-1) = **0.25**       | –Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è ‚Üí 0                   | (1,1) ‚Üí 1 / (4+4-1) = 1/7 ‚âà **0.14** |
| Box3 (0,0,1,1) | –Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è ‚Üí 0                | —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí 1 / (1+1-1) = 1 ‚Üí **1.0** | –Ω–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è ‚Üí 0                  |

"""